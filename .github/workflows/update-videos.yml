name: 更新视频数据

on:
  schedule:
    - cron: "0 * * * *"  # 每小时运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  update-videos:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 获取视频数据
        run: |
          mkdir -p videos  # 确保 /videos 目录存在
          curl -s "https://slapibf.com/api.php/provide/vod/?ac=detail&h=24" -o videos/response.json
          
          # 提取新数据
          jq '.list | map({
              vod_name: .vod_name,
              vod_time: .vod_time,
              vod_play_url: (.vod_play_url | split("#") | map(split("$")[1]) | .[0]),
              type_name: .type_name
          })' videos/response.json > videos/new_videos.json

          # 合并旧数据
          if [ -f videos/videos.json ]; then
            jq -s '.[0] + .[1] | unique_by(.vod_name)' videos/videos.json videos/new_videos.json > videos/merged.json
            mv videos/merged.json videos/videos.json
          else
            mv videos/new_videos.json videos/videos.json
          fi

      - name: 配置 Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: 提交更新
        run: |
          git add videos/videos.json
          git commit -m "自动更新视频数据"
          git push https://github.com/${{ github.repository }}.git main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}  # 这里需要你的 GitHub 个人访问令牌
